import re
from sys import stdout
from time import time

import numpy as np
import pandas as pd
import scipy.stats as st
from joblib import Parallel, delayed
from tabulate import tabulate

from application.CSFSConditionEvaluation import AucForBudgetCalculator, AUCForOrderedFeaturesCalculator
from infoformulas_listcomp import _H, IG_from_series


class ERCondition:
    LAYPERSON = 1 # AMT Turkers
    DOMAIN = 2 # e.g. Teachers
    EXPERT = 3 # Upwork
    CSFS = 4
    RANDOM = 5
    ACTUAL = 6

    @staticmethod
    def get_all():
        return [ERCondition.LAYPERSON, ERCondition.DOMAIN, ERCondition.EXPERT, ERCondition.CSFS, ERCondition.RANDOM, ERCondition.ACTUAL]


class ERFilterer:

    def __init__(self, dataset_name, condition, remove_test=False):
        """

        :param dataset_name:
        :param condition:
        :param remove_test: whether to remove rows with 'test' in the name field
        :return:
        """
        self.dataset_name = dataset_name
        self.condition = condition
        self.remove_test = remove_test

    def get_filtered_result(self, df_evaluation_result):
        """
        Removes all conditions but condition from df_result
        :param condition: int
        :return: df
        """
        df_result_filtered = df_evaluation_result[(df_evaluation_result['condition'] == self.condition) & (df_evaluation_result['dataset_name'] == self.dataset_name)]
        if self.remove_test:
            index_keep = df_result_filtered['name'].str.lower() != 'test'
            df_result_filtered = df_result_filtered[index_keep]
        print('Filterer removed {} rows from {} rows'.format(len(df_evaluation_result) - len(df_result_filtered), len(df_evaluation_result)))
        if len(df_result_filtered) == 0:
            # no answers available
            return pd.DataFrame()
        return df_result_filtered

class ERParser:
    def __init__(self, df_evaluation_base):
        """

        :param df_evaluation_base: df_cost_ig
        :return:
        """
        self.df_evaluation_base = df_evaluation_base

    def _extract_index_value(self, ranking):
        indeces = list()
        values = list()
        for element in ranking.split(','):
            match = re.search(r'(\d+):(\d+)', element)
            index = match.group(1)
            value = match.group(2)
            indeces.append(index)
            values.append(value)
        # need integers
        return dict(index=np.array(indeces, dtype='int'), No=np.array(values, dtype='int'))

    def parse(self, token):
        ranking = re.search(r'^(.*)\|.+$', token).group(1)
        df_ranking = pd.DataFrame(self._extract_index_value(ranking))
        df_merged = pd.merge(df_ranking, self.df_evaluation_base, on='No')
        df_merged.index = list(df_merged['index'])
        df_merged = df_merged.drop('index', axis=1)
        return df_merged

    def get_ordered_features(self, token):
        """
        Extracts the ordered list of features from token
        :param token: str e.g. '0:13,1:14,2:1,3:3,4:4,5:7,6:11,7:5,8:12,9:15,10:6,11:2,12:8,13:9,14:10|e7cf0fccca7858d47a96c82837e6d439'
        :return: list(str)
        """
        df_merged = self.parse(token)
        return df_merged


class EREvaluator:
    """

         ci_95_hi  ci_95_low      mean       std
10        NaN        NaN  0.000000  0.000000
20   0.781988   0.135474  0.458731  0.232857
30   0.630208   0.518547  0.574378  0.040217
40   0.635273   0.549133  0.592203  0.031025
50   0.637656   0.553728  0.595692  0.030229
60   0.641157   0.600360  0.620759  0.014694
70   0.639263   0.598034  0.618649  0.0148
    """

    def __init__(self, df_evaluation_result, df_evaluation_base, df_cleaned_bin, target, dataset_name, df_answers_grouped, df_actual_metadata, bootstrap_n=12, repetitions=100, ):
        self.df_evaluation_result = df_evaluation_result
        self.df_evaluation_base = df_evaluation_base
        self.df_cleaned_bin = df_cleaned_bin
        self.df_actual_metadata = df_actual_metadata
        self.parser = ERParser(df_evaluation_base)
        self.target = target
        self.dataset_name = dataset_name
        self.df_answers_grouped = df_answers_grouped
        self.bootstrap_n = bootstrap_n
        self.repetitions = repetitions

    def evaluate(self, budget_range, condition):
        pass

    def _get_filtered_result(self, condition):
        """
        Removes all conditions but condition from df_result
        :param condition: int
        :return: df
        """
        filterer = ERFilterer(self.dataset_name, condition, remove_test=True)
        df_result_filtered = filterer.get_filtered_result(self.df_evaluation_result)
        return df_result_filtered

    def _get_df_evaluated(self, df):
        """
        df with columns index= x times 'AUC' and columns=cost or no_features
        :param df:
        :return:
        """
        mean = np.mean(df)
        std = np.std(df)
        # http://stackoverflow.com/questions/15033511/compute-a-confidence-interval-from-sample-data
        # The underlying assumptions for both are that the sample (array a) was drawn independently from a normal distribution with unknown standard deviation
        ci_intervals = [st.t.interval(0.95, len(df[cost])-1, loc=np.mean(df[cost]), scale=st.sem(df[cost])) for cost in df]
        ci_low = [e[0] for e in ci_intervals]
        ci_high = [e[1] for e in ci_intervals]

        df_evaluated = pd.DataFrame(dict(auc=mean, std=std, ci_lo=ci_low, ci_hi=ci_high))
        return df_evaluated

    def evaluate_all_to_dict(self, budget_range):
        raw_data = Parallel(n_jobs=4)(delayed(self.evaluate)(budget_range, condition) for condition in ERCondition.get_all())
        # [{1: {1: [0.580804915514593, 0.5437019969278033, 0.5437019969278033, 0.5175591397849462, 0.5802751874943526, 0.570786888949128, 0.580804915514593, 0.580804915514593, 0.5998979850004519, 0.4820827685913075, 0.5437019969278033, 0.40234539622300536, 0.4816196801301166, 0.5956785488388905, 0.5437019969278033, 0.5437019969278033, 0.46145197433812235, 0.5270353302611366, 0.5392491190024395, 0.6222022228246138, 0.5998979850004519], 2: [0.6583908918406073, 0.5475115207373271, 0.5475115207373271, 0.5425591397849463, 0.606449037679588, 0.654862654739315, 0.5721284449263576, 0.5636133098400651, 0.5845139152435167, 0.48198472937562126, 0.5475115207373271, 0.5226208999728924, 0.5039153790548478, 0.6104446552814675, 0.5437019969278033, 0.5437019969278033, 0.5602537724767325, 0.5475115207373271, 0.6206692870696665, 0.606449037679588, 0.6018503659528328], 3: [0.6675679045811874, 0.5475115207373271, 0.5432491190024396, 0.5425591397849463, 0.5898481069847293, 0.6393528056383844, 0.587049697298274, 0.5597707599168699, 0.6113181078883165, 0.5663687991325562, 0.6115875124243246, 0.5150294569440679, 0.5250820457215144, 0.6104446552814675, 0.6104446552814675, 0.5475115207373271, 0.5805618053673082, 0.5306841962591489, 0.6420040661425861, 0.6113181078883165, 0.5562436974789916], 4: [0.6719152435167616, 0.5432491190024396, 0.569083762537273, 0.6067205656456132, 0.6121846480527695, 0.6408289961145749, 0.6079110418360892, 0.5748343724586608, 0.5953995210987622, 0.5875664588416012, 0.6115875124243246, 0.5350154965211892, 0.6023817656094697, 0.6115875124243246, 0.6067205656456132, 0.6115875124243246, 0.6540940182524623, 0.6105700731905666, 0.6405739586157042, 0.5781090629800307, 0.6348462546308846], 5: [0.6719152435167616, 0.6049574862202947, 0.6250445920303606, 0.6000457215144123, 0.6164928164814313, 0.6349242342098129, 0.6079110418360892, 0.6511817113942351, 0.6164928164814313, 0.5531234300171681, 0.6079110418360892, 0.557435664588416, 0.6613455769404536, 0.6049574862202947, 0.6000457215144123, 0.6544464624559502, 0.6576794524261318, 0.6514582090900878, 0.619258064516129, 0.6373289961145749, 0.6740710671365319], 6: [0.6689616879009669, 0.6689616879009669, 0.6853513147194362, 0.6024742929429837, 0.5844079244601066, 0.6446002981837896, 0.5940646064877563, 0.6577447366043192, 0.6529133459835548, 0.5883111050871962, 0.6266476461552364, 0.6223124152886961, 0.6963855606758832, 0.5849237372368302, 0.6024742929429837, 0.6491782325833559, 0.6535274690521369, 0.6635336586247401, 0.6080069576217584, 0.6793112406252824, 0.6729988705159483], 7: [0.6651521640914431, 0.6853513147194362, 0.6853513147194362, 0.6651521640914431, 0.5665831752055661, 0.6507179452426131, 0.636710400289148, 0.6456897533206831, 0.6332474925454052, 0.5681256438059095, 0.6138602602331253, 0.6317886057648865, 0.6862683202313182, 0.6059116291677962, 0.6225585976326015, 0.6366500406614258, 0.65648251558688, 0.6599967019065691, 0.5802770850275595, 0.671977907291949, 0.6669267642540888], 8: [0.6551041836089274, 0.6814941718622933, 0.674373949579832, 0.6535777536821181, 0.5672483057739225, 0.6354836902502936, 0.6682311376163368, 0.6344600162645703, 0.6343427306406433, 0.6247531399656637, 0.6048829402728834, 0.6220774826059456, 0.6833635583265564, 0.6705022137887413, 0.6104957983193275, 0.6333561940905394, 0.6476044546850999, 0.6480251197253095, 0.6410638836179633, 0.6623842052950213, 0.6585458118731364], 9: [0.6853283184241439, 0.7035808710581006, 0.6998736333242975, 0.6713263305322129, 0.6233796421794524, 0.6400619860847565, 0.6591191831571339, 0.6379231047257613, 0.6321998734977863, 0.6219459203036053, 0.6432516942260775, 0.6183519924098672, 0.6815064154694135, 0.6658177916327821, 0.6549902864371555, 0.6859058462094516, 0.6660236288063612, 0.6949392337580192, 0.6361094695942893, 0.6550971356284448, 0.6712396765157675], 10: [0.6763160296376615, 0.6977100388542514, 0.6983124604680582, 0.6581109153338754, 0.6232367850365954, 0.638199783139062, 0.6547984096864553, 0.6568902141501762, 0.6253796421794524, 0.6721181892111683, 0.6445626185958254, 0.6324400018071745, 0.7049316436251921, 0.6568902141501762, 0.6480754947140146, 0.6822048432276137, 0.6657934399566279, 0.6935582813770671, 0.6721181892111683, 0.6906335953736333, 0.6980841239721696], 11: [0.6680901328273245, 0.7113739947591939, 0.6942686364868528, 0.6540806903406524, 0.6256785036595283, 0.6559354838709677, 0.6511912894189933, 0.6540806903406524, 0.6250524532393603, 0.6742134273064064, 0.6910686274509804, 0.6782573416463359, 0.7043574139333153, 0.6863333785126955, 0.6660977229601518, 0.6942686364868528, 0.6555251197253094, 0.7115539441583085, 0.6742134273064064, 0.6914431191831573, 0.6961746182343906], 12: [0.6688978946417276, 0.7064110870154514, 0.68981905665492, 0.6539429384657088, 0.6723988434083312, 0.6785486129935845, 0.6594884340833107, 0.6539429384657088, 0.6737910002710762, 0.7024617782596909, 0.6832258064516129, 0.6770597271166532, 0.7042080509623204, 0.6802632149634047, 0.6603629258154874, 0.7073605313092979, 0.6869650311737598, 0.7097269811150266, 0.7024617782596909, 0.6968352760459021, 0.6957026294388723], 13: [0.6829958434986898, 0.7041555525435982, 0.6829958434986898, 0.6829958434986898, 0.6744432547212433, 0.7015141863196892, 0.6577614077889221, 0.6829958434986898, 0.7022236830215958, 0.7022236830215958, 0.6829958434986898, 0.677455091714105, 0.7010658263305323, 0.7041946326917864, 0.7026462455950122, 0.7026462455950122, 0.7041946326917864, 0.7041946326917864, 0.7022236830215958, 0.7022236830215958, 0.6912194361615616]}}, {2: {1: [0.5998979850004519, 0.6222022228246138, 0.5392491190024395, 0.6214330893647781, 0.5956785488388905, 0.5691994217041654, 0.601010662329448, 0.5150809614168248, 0.5266152525526339, 0.5266152525526339, 0.5675117918134995, 0.5150809614168248, 0.5165236288063613, 0.5321265925725128, 0.5437019969278033, 0.5998979850004519, 0.48530875576036864, 0.4530110237643445], 2: [0.6234833288153971, 0.5968856510346074, 0.6206692870696665, 0.6417596457938014, 0.6104446552814675, 0.5250820457215144, 0.6143854703171592, 0.5118820818650041, 0.6060824975151352, 0.4775029818378965, 0.5925105267913617, 0.5927042558959068, 0.5392491190024395, 0.6026512153248396, 0.6209092798409687, 0.5539103641456583, 0.5636133098400651, 0.49138022951115934], 3: [0.6704246860034335, 0.5723516761543326, 0.6420040661425861, 0.6874133008041926, 0.6104446552814675, 0.6029055751332792, 0.6226711846028734, 0.6035442757748261, 0.6776871329176833, 0.4539074274871238, 0.5937962410770761, 0.5930902683654107, 0.620145477545857, 0.596888723231228, 0.6412358362699919, 0.5466143489653926, 0.5878489653926087, 0.5898481069847293], 4: [0.6406990602692689, 0.5952243155326646, 0.6405739586157042, 0.6704213427306407, 0.6568274148369025, 0.6049381042739677, 0.6718681666214873, 0.5797598716906117, 0.6881206288967199, 0.44978639197614523, 0.5923408782867986, 0.6612447817836813, 0.6218121442125237, 0.5800289147917231, 0.6427120267461823, 0.5450905394415831, 0.6031543778801843, 0.6121846480527695], 5: [0.6362704888406975, 0.5963274148369024, 0.6309001987891931, 0.6708219481340925, 0.6687205656456131, 0.6619676515767597, 0.6846990150899068, 0.6381128580464444, 0.6708219481340925, 0.4977624017348875, 0.619258064516129, 0.64333107436523, 0.6689616879009669, 0.5966827053402006, 0.6872428842504744, 0.612290141863197, 0.6174484955272431, 0.6164928164814313], 6: [0.6155082226438962, 0.5936474654377879, 0.6740141411403271, 0.6726314719436162, 0.6659110418360893, 0.6564609198518115, 0.6666118189211169, 0.6398072648414205, 0.6726314719436162, 0.5844079244601066, 0.5966592120719255, 0.6608763440860215, 0.6535274690521369, 0.6144117647058823, 0.6853513147194362, 0.6331385199240988, 0.6152436071202675, 0.6720627993132737], 7: [0.6128730911719527, 0.5665831752055661, 0.6516543778801843, 0.6668695671817113, 0.6605875124243246, 0.6528843860124696, 0.6679927713020692, 0.6197206108249752, 0.7022517845848018, 0.5665831752055661, 0.6401725399837355, 0.6416734435709768, 0.6767549019607844, 0.6038377157314538, 0.6767549019607844, 0.6197206108249752, 0.6152436071202675, 0.6493027920845759], 8: [0.6037125237191651, 0.5684387819643987, 0.6516543778801843, 0.657126637751875, 0.6605085840787929, 0.6799476822987259, 0.6564329086473298, 0.639959157856691, 0.6946851902051143, 0.6250463088461191, 0.6391486401012018, 0.6250463088461191, 0.674373949579832, 0.6490941537905485, 0.6707072829131653, 0.6037125237191651, 0.6759466883527605, 0.6503980301798139], 9: [0.6550971356284448, 0.5684387819643987, 0.6398163007138339, 0.643825788379868, 0.6522901418631969, 0.6762810156320593, 0.6934474112225535, 0.6233796421794524, 0.6956375711574952, 0.6751658082587875, 0.6233796421794524, 0.6233796421794524, 0.6713263305322129, 0.6912089997289238, 0.6949184512514684, 0.6582507906388362, 0.672422878828951, 0.6895829041293937], 10: [0.6559066594379688, 0.6270463088461191, 0.6789542333062257, 0.6839573958615703, 0.6488751242432457, 0.669712433360441, 0.6894950302701724, 0.6232367850365954, 0.7143983916147104, 0.7068903496882623, 0.6232367850365954, 0.6253796421794524, 0.6957783952290594, 0.6927632601427667, 0.6873994759194, 0.6721181892111683, 0.6968756663955905, 0.6847733803198699], 11: [0.6914431191831573, 0.673712433360441, 0.669712433360441, 0.6849864461913798, 0.6409923195084485, 0.6702362428842504, 0.6813710129212974, 0.6717910002710762, 0.70750939730731, 0.7018903496882624, 0.6256785036595283, 0.6702362428842504, 0.6941023764344447, 0.6888108791903857, 0.6888108791903857, 0.7018903496882624, 0.7113739947591939, 0.6793293575494713], 12: [0.7024617782596909, 0.6802632149634047, 0.7018427306406434, 0.6869650311737598, 0.6603629258154874, 0.7024617782596909, 0.7014320502394507, 0.6723988434083312, 0.7024617782596909, 0.7024617782596909, 0.6339670190656908, 0.7024617782596909, 0.6854093701996928, 0.7050253456221199, 0.6815144573958616, 0.7018427306406434, 0.708233215866992, 0.7024617782596909], 13: [0.7022236830215958, 0.7041946326917864, 0.7022236830215958, 0.7041946326917864, 0.7026462455950122, 0.7022236830215958, 0.7010658263305323, 0.7022898707870245, 0.7022236830215958, 0.7022236830215958, 0.677455091714105, 0.7022236830215958, 0.6829958434986898, 0.7026462455950122, 0.6829958434986898, 0.7022236830215958, 0.7041555525435982, 0.7022236830215958]}}, {3: {1: [0.5527618144031806, 0.5270353302611366, 0.657200415650131, 0.5979395500135538, 0.4416040028914791, 0.4416040028914791, 0.46145197433812235, 0.5437019969278033, 0.5270353302611366, 0.4416040028914791, 0.5437019969278033, 0.5266152525526339, 0.657200415650131, 0.5802751874943526, 0.5767814222463178, 0.5437019969278033, 0.5691994217041654], 2: [0.5428828950935213, 0.5205236288063613, 0.6941485949218398, 0.5973712839974701, 0.549865229962953, 0.549865229962953, 0.5602537724767325, 0.5437019969278033, 0.5475115207373271, 0.549865229962953, 0.5425591397849463, 0.6234833288153971, 0.6583908918406073, 0.6410937019969278, 0.5444832384566729, 0.5437019969278033, 0.6417596457938014], 3: [0.5123795518207283, 0.5889896991054486, 0.6832680039757839, 0.6155110689437067, 0.6232410318966297, 0.5805693955001356, 0.5976010210535827, 0.6209092798409687, 0.5475115207373271, 0.5805693955001356, 0.509591759284359, 0.5836931417728382, 0.6675679045811874, 0.6267183066775097, 0.5452494352579741, 0.5475115207373271, 0.6420040661425861], 4: [0.5491945875124242, 0.6049574862202947, 0.695705114303786, 0.6805805548025662, 0.6237617240444565, 0.5836685641998736, 0.5976010210535827, 0.6226711846028734, 0.5432491190024396, 0.5836685641998736, 0.5068298545224541, 0.5604638113309839, 0.6719152435167616, 0.6263528056383844, 0.5391696033252009, 0.5129278937381404, 0.6430025300442758], 5: [0.6209819734345351, 0.6049574862202947, 0.7029006054034518, 0.6875492003252914, 0.620190295473028, 0.5537468148549743, 0.5970772115297731, 0.6719152435167616, 0.6049574862202947, 0.64333107436523, 0.5904931779163278, 0.6276794524261319, 0.6719152435167616, 0.6700018975332069, 0.559231227975061, 0.5970772115297731, 0.6199247311827957], 6: [0.6709983735429657, 0.6689616879009669, 0.6995485226348603, 0.7107108069034065, 0.5956904310111141, 0.554365862474022, 0.6203453510436432, 0.6604440227703985, 0.589636712749616, 0.6230539441583085, 0.6553487846751603, 0.6230539441583085, 0.6689616879009669, 0.6846431282190295, 0.62742089093702, 0.6604440227703985, 0.6208771121351766], 7: [0.670813725490196, 0.6853513147194362, 0.6852211981566819, 0.7089489021415017, 0.6197206108249752, 0.6197206108249752, 0.6144117647058823, 0.6574916418180176, 0.65648251558688, 0.6197206108249752, 0.6502444203487847, 0.6416734435709768, 0.6853513147194362, 0.6887841781874041, 0.6354985090810518, 0.6899371555073642, 0.5987544501671636], 8: [0.6766204481792716, 0.6814941718622933, 0.6898878648233489, 0.7089489021415017, 0.6654797596457938, 0.6215777536821181, 0.674373949579832, 0.6739714014638112, 0.6535777536821181, 0.6319461010210536, 0.6535777536821181, 0.6250463088461191, 0.674373949579832, 0.7150327098581368, 0.6547438330170777, 0.6860323936026024, 0.595647465437788], 9: [0.6819127586518479, 0.6713263305322129, 0.6823441312008675, 0.6998736333242975, 0.6941904310111141, 0.635977907291949, 0.6713263305322129, 0.6713263305322129, 0.6713263305322129, 0.6372510165356464, 0.6713263305322129, 0.6233796421794524, 0.6660236288063612, 0.7078748983464352, 0.6390162645703443, 0.697806361254179, 0.595647465437788], 10: [0.6881508538899432, 0.6581109153338754, 0.7119225173940544, 0.6927632601427667, 0.6996368031083401, 0.6460605403451704, 0.6581109153338754, 0.6957783952290594, 0.6668621125869703, 0.6383938736785036, 0.6957783952290594, 0.6721181892111683, 0.6927632601427667, 0.704028146742568, 0.6771862745098038, 0.686528869612361, 0.5690578295834463], 11: [0.7048477003704707, 0.6540806903406524, 0.7092186229330442, 0.6888108791903857, 0.6958376705520918, 0.6762132465889582, 0.6540806903406524, 0.6888108791903857, 0.6634493539351224, 0.6776162916779616, 0.6860304960693955, 0.6742134273064064, 0.6888108791903857, 0.6958376705520918, 0.6801478720520466, 0.6813710129212974, 0.6250524532393603], 12: [0.7036843769765971, 0.6815144573958616, 0.7007516490467154, 0.68981905665492, 0.7019700912623115, 0.6702671907472667, 0.6815144573958616, 0.7050253456221199, 0.683002665582362, 0.6695909460558417, 0.7042080509623204, 0.6709310562934852, 0.6815144573958616, 0.7007516490467154, 0.6815144573958616, 0.6832258064516129, 0.6737910002710762], 13: [0.7041946326917864, 0.7010658263305323, 0.6988272341194542, 0.7026462455950122, 0.7022898707870245, 0.6989700912623114, 0.7010658263305323, 0.7010658263305323, 0.7026462455950122, 0.7022898707870245, 0.7010658263305323, 0.6744432547212433, 0.7010658263305323, 0.6989700912623114, 0.7010658263305323, 0.6999818830758111, 0.6744432547212433]}}, {4: {1: [0.5437019969278033, 0.5437019969278033, 0.56919942170416538, 0.56919942170416538, 0.56919942170416538, 0.53212659257251282, 0.53212659257251282, 0.53212659257251282, 0.5437019969278033, 0.5437019969278033, 0.5437019969278033, 0.5437019969278033, 0.5437019969278033, 0.5437019969278033, 0.5437019969278033, 0.5508296738050058, 0.5508296738050058, 0.53212659257251282, 0.53212659257251282, 0.53212659257251282], 2: [0.62090927984096866, 0.62090927984096866, 0.56919942170416538, 0.55464317339839164, 0.6417596457938014, 0.62305936568175668, 0.48261968013011664, 0.48261968013011664, 0.5437019969278033, 0.5437019969278033, 0.5437019969278033, 0.61044465528146752, 0.62090927984096866, 0.5437019969278033, 0.5437019969278033, 0.56919942170416538, 0.56919942170416538, 0.48261968013011664, 0.48261968013011664, 0.48261968013011664], 3: [0.60471640914430291, 0.59326470588235292, 0.53892577030812316, 0.55464317339839164, 0.64123583626999192, 0.58260856600704791, 0.58260856600704791, 0.58260856600704791, 0.61044465528146752, 0.61044465528146752, 0.61044465528146752, 0.61044465528146752, 0.62090927984096866, 0.61044465528146752, 0.61044465528146752, 0.56919942170416538, 0.56919942170416538, 0.45771911990602698, 0.45771911990602698, 0.45771911990602698], 4: [0.62792748712388169, 0.61710224089635846, 0.61710224089635846, 0.62845129664769117, 0.64123583626999192, 0.59047131110508722, 0.60566187765428758, 0.60566187765428758, 0.61158751242432463, 0.61158751242432463, 0.61158751242432463, 0.67139143399295209, 0.64123583626999192, 0.61158751242432463, 0.61158751242432463, 0.63004120357820548, 0.63004120357820548, 0.49593313454414023, 0.49593313454414023, 0.49593313454414023], 5: [0.62792748712388169, 0.61710224089635846, 0.61710224089635846, 0.62792748712388169, 0.62792748712388169, 0.65209645793801385, 0.61304843227613637, 0.61304843227613637, 0.67191524351676157, 0.67191524351676157, 0.67191524351676157, 0.67191524351676157, 0.60238176560946965, 0.67191524351676157, 0.60267782596909725, 0.63027929881630074, 0.63027929881630074, 0.58878467516038668, 0.58878467516038668, 0.58878467516038668], 6: [0.61208940995753136, 0.61208940995753136, 0.62102552633956809, 0.67481964398662686, 0.67481964398662686, 0.66453605313092978, 0.60580401192735156, 0.60580401192735156, 0.66805810065961868, 0.66805810065961868, 0.66805810065961868, 0.68724288425047442, 0.66453031535194707, 0.66805810065961868, 0.59936550103912523, 0.62228819915062794, 0.62228819915062794, 0.59744433902593297, 0.59744433902593297, 0.59744433902593297], 7: [0.57865424234209806, 0.57865424234209806, 0.59351635492906829, 0.65859424414927259, 0.67120059636757934, 0.65572250835818191, 0.58701879461462003, 0.65572250835818191, 0.69622377338031982, 0.69622377338031982, 0.69622377338031982, 0.68333812234571256, 0.6603398391614711, 0.69622377338031982, 0.66402692689979226, 0.61902209270805097, 0.61902209270805097, 0.59744433902593297, 0.59744433902593297, 0.59744433902593297], 8: [0.59189233758019344, 0.65380351495436884, 0.59207603686635946, 0.64688845215505553, 0.6545942441492727, 0.64052281557784396, 0.57726705520918042, 0.65515107978675335, 0.69290512333965848, 0.69290512333965848, 0.69290512333965848, 0.70610291858678953, 0.64891686997379594, 0.69290512333965848, 0.69365338393421883, 0.67755426041384292, 0.67755426041384292, 0.57891054486310656, 0.57891054486310656, 0.57891054486310656], 9: [0.66380351495436896, 0.64439373814041745, 0.65882569802114399, 0.64439373814041745, 0.68627080509623195, 0.64104662510165356, 0.5779813409234662, 0.64104662510165356, 0.68268631968916593, 0.68268631968916593, 0.68268631968916593, 0.69672788470226799, 0.64451364416734436, 0.68268631968916593, 0.68180197885605864, 0.70274243245685386, 0.70274243245685386, 0.5779813409234662, 0.5779813409234662, 0.5779813409234662], 10: [0.66098323845667295, 0.65491754766422694, 0.64428702448721431, 0.64428702448721431, 0.68579940363242076, 0.64415211891208091, 0.58172449625011302, 0.64415211891208091, 0.70547316345893196, 0.70547316345893196, 0.70547316345893196, 0.69687566639559051, 0.68240909912352044, 0.70547316345893196, 0.68102258968103369, 0.69529190385831752, 0.69529190385831752, 0.58172449625011302, 0.58172449625011302, 0.58172449625011302], 11: [0.66278955453149002, 0.65552511972530936, 0.65552511972530936, 0.67321794524261325, 0.68715754043552912, 0.68498644619137983, 0.64080974970633409, 0.64080974970633409, 0.69907698563296283, 0.69907698563296283, 0.69907698563296283, 0.68881087919038575, 0.68071320140959612, 0.69907698563296283, 0.69907698563296283, 0.69410237643444472, 0.69410237643444472, 0.63625273335140509, 0.63625273335140509, 0.63625273335140509], 12: [0.6845704798048251, 0.65394293846570883, 0.68026321496340469, 0.66959094605584168, 0.67943982108972611, 0.68696503117375984, 0.64285736875395316, 0.68696503117375984, 0.70545210987620854, 0.70545210987620854, 0.70545210987620854, 0.70502534562211994, 0.6832258064516129, 0.70545210987620854, 0.69472160477094058, 0.70545210987620854, 0.70545210987620854, 0.67568455769404534, 0.67568455769404534, 0.67568455769404534], 13: [0.67745509171410501, 0.6829958434986898, 0.67745509171410501, 0.67745509171410501, 0.6829958434986898, 0.70419463269178639, 0.6829958434986898, 0.70419463269178639, 0.7015141863196892, 0.7015141863196892, 0.7015141863196892, 0.70264624559501221, 0.6829958434986898, 0.7015141863196892, 0.70264624559501221, 0.70264624559501221, 0.70264624559501221, 0.67444325472124333, 0.67444325472124333, 0.67444325472124333]}}, {5: {1: [0.58027518749435258, 0.5508296738050058, 0.42138596729014183, 0.57078688894912799, 0.66210133730911713, 0.63590462636667566, 0.5150809614168248, 0.62143308936477815, 0.59562970994849551, 0.60359447004608291, 0.42138596729014183, 0.5150809614168248, 0.52703533026113658, 0.44160400289147911, 0.49463734526068504, 0.53212659257251282, 0.49463734526068504, 0.54621437607300982, 0.56751179181349953, 0.58499259058462083, 0.5437019969278033, 0.49346954910996654, 0.54621437607300982, 0.48178670823167985, 0.56462880636125412, 0.54621437607300982, 0.63590462636667566, 0.50934453781512601, 0.56751179181349953, 0.59793955001355381, 0.50816598897623566, 0.44751576759736161, 0.56751179181349953, 0.63590462636667566, 0.61830514141140347, 0.43998838890394865, 0.45402245414294751, 0.43920344266738959, 0.56751179181349953, 0.45266942260775272, 0.44751576759736161, 0.59295197433812241, 0.4820827685913075, 0.5150809614168248, 0.5437019969278033, 0.61830514141140347, 0.60759284358904853, 0.63590462636667566, 0.45402245414294751, 0.57078688894912799, 0.50391659889762352, 0.55786003433631515, 0.60461317430197881, 0.56965225445016721, 0.61044465528146752, 0.52428571428571424, 0.5437019969278033, 0.54621437607300982, 0.54835348332881539, 0.518396132646607, 0.50816598897623566, 0.5437019969278033, 0.601010662329448, 0.55734901057197062, 0.52588569621396952, 0.50934453781512601, 0.46923895364597457, 0.52703533026113658, 0.59562970994849551, 0.56963350501490917, 0.55276181440318062, 0.49463734526068504, 0.46923895364597457, 0.56919942170416538, 0.5608990241257793, 0.59295197433812241, 0.49438772928526253, 0.60461317430197881, 0.48293837535014006, 0.45402245414294751, 0.44160400289147911, 0.47839839161471043, 0.54329908737688615, 0.54329908737688615, 0.46570732809252735, 0.5259699105448632, 0.518396132646607, 0.54835348332881539, 0.63590462636667566, 0.61262356555525432, 0.52703533026113658, 0.58499259058462083, 0.59562970994849551, 0.59989798500045188, 0.54621437607300982, 0.44751576759736161, 0.5608990241257793, 0.5259699105448632, 0.45266942260775272, 0.5508296738050058], 2: [0.6052402186681124, 0.62054314629077445, 0.41941257793439951, 0.58670705701635495, 0.67463007138339204, 0.66874686003433637, 0.58708706063070404, 0.57606668473841149, 0.61995689888858763, 0.64748305773922477, 0.44672964669738863, 0.5170809614168248, 0.61378133188759365, 0.44035773018884977, 0.55917055209180444, 0.57143751694226075, 0.55917055209180444, 0.56433030631607484, 0.58179203939640378, 0.56158995210987617, 0.53924911900243955, 0.44792098129574409, 0.56876981115026659, 0.45085375440498776, 0.58441230685822709, 0.58148997018162107, 0.64937277491641809, 0.50934453781512601, 0.58179203939640378, 0.64554938104273973, 0.50816598897623566, 0.40672634860395779, 0.59688565103460745, 0.63814272160477103, 0.63409957531399663, 0.55391036414565831, 0.47639635854341733, 0.49258069034065244, 0.52065211891208096, 0.48020303605313081, 0.47112221017439238, 0.59046597994036332, 0.5845139152435167, 0.60644903767958802, 0.62090927984096866, 0.59998219933134533, 0.5775756302521009, 0.64748305773922477, 0.46007007319056659, 0.57373926990150892, 0.50777374175476642, 0.54971862293304408, 0.60205688081684283, 0.57212844492635762, 0.60662532755037502, 0.47112221017439238, 0.54751152073732712, 0.62298662690882789, 0.56919942170416538, 0.60216766061263205, 0.50949652118912081, 0.54751152073732712, 0.5700832203849282, 0.58481648143128218, 0.52798093430920745, 0.53892577030812316, 0.45658290412939373, 0.48490562031264117, 0.65000993945965491, 0.64670127405801026, 0.52065211891208096, 0.49424179994578477, 0.57517425679949397, 0.6417596457938014, 0.62336771482786657, 0.64748305773922477, 0.48198472937562126, 0.55917055209180444, 0.47593205023945051, 0.52778883166169688, 0.55085248938284992, 0.48220791542423419, 0.57889952109876197, 0.5303862835456763, 0.54146250112948402, 0.60605014909189481, 0.52025607662419804, 0.5161216680220474, 0.62899643083039669, 0.67244939911448454, 0.54751152073732712, 0.65717484413120086, 0.59727893738140414, 0.60185036595283281, 0.51155005873317072, 0.54940485226348601, 0.62352606849191283, 0.48251707779886149, 0.55807874762808352, 0.56919942170416538], 3: [0.58532980934309209, 0.57431051775548925, 0.53445748622029454, 0.60970244872142398, 0.66109984639016894, 0.65186870877383218, 0.58402078250655109, 0.57764398662690886, 0.61943308936477814, 0.69872142405349247, 0.55965835366404626, 0.5371512605042017, 0.67021130387638927, 0.54938578657269355, 0.57676298906659429, 0.63676624198066334, 0.5375034336315172, 0.58466327821451158, 0.64782127044366133, 0.55750031625553453, 0.53939477726574503, 0.47299611457486213, 0.58373339658444023, 0.47624505285985358, 0.57065424234209816, 0.58148997018162107, 0.62299841872232764, 0.47624505285985358, 0.5354418541610193, 0.63159817475377245, 0.53984291135809159, 0.43445183880003613, 0.65395807355200142, 0.61016079334959783, 0.63405195626637756, 0.56555182072829124, 0.44308959067497966, 0.57511430378603057, 0.60689297009126242, 0.57097370561127669, 0.5664692780337941, 0.59294217041655384, 0.56522318604861299, 0.65929167796150723, 0.67139143399295209, 0.60579172314086926, 0.58780112044817934, 0.67450036143489656, 0.56298097948856962, 0.55827053402005977, 0.48410766241980657, 0.63472205656456127, 0.64592816481431281, 0.58704969729827405, 0.65726231137616342, 0.49613111050871972, 0.54324911900243955, 0.61731996024216129, 0.63447031715912172, 0.55806203126411857, 0.60017000993945957, 0.51464217945242607, 0.59840946055841693, 0.55661132194813412, 0.54811258697027188, 0.61762605042016794, 0.47124957079606034, 0.46487060630703886, 0.65999647600975875, 0.62538190114755587, 0.51955688081684293, 0.51241628264208905, 0.56443055932050235, 0.68664764615523632, 0.63774812505647416, 0.61944957983193283, 0.4526252823710129, 0.62176244691424942, 0.57378078973524904, 0.53055082678232579, 0.62324103189662972, 0.52848811782777627, 0.56867461823439058, 0.58924735700731912, 0.54255362790277406, 0.57663901689708141, 0.48825838077166345, 0.60616996476009755, 0.65439590674979675, 0.66773511340019887, 0.51464217945242607, 0.69057472666485953, 0.57169015993494177, 0.58651391524351681, 0.54942924911900248, 0.57418744917321773, 0.68407075088099756, 0.5744568537092255, 0.57097370561127669, 0.53892577030812316], 4: [0.5848059998192825, 0.55316716363964946, 0.59922960151802651, 0.61094054395951924, 0.66367127496159761, 0.63983649588867808, 0.57810201499954827, 0.64119630432818286, 0.60343069485858869, 0.67464547754585702, 0.55153370380410227, 0.60750144573958609, 0.6995379506641366, 0.57280839432547215, 0.57570696665763077, 0.67000474383301711, 0.57095513689346711, 0.59976972079154245, 0.61508434986897975, 0.5978013463449896, 0.54363287250384029, 0.57464434806180542, 0.55482136080238553, 0.51040078612090001, 0.56648192825517307, 0.63502652028553364, 0.64766002530044275, 0.57815035691696037, 0.62117818740399389, 0.64902069214782687, 0.61851996927803377, 0.4377699015089907, 0.67171464714918228, 0.62267059727116647, 0.62345387187132917, 0.63235863377609114, 0.48002123430017168, 0.6424627722056564, 0.62160400289147921, 0.57587846751603855, 0.53740159934941722, 0.63891343634227882, 0.5755993945965483, 0.64263666757025395, 0.65758421433089365, 0.60255923014367041, 0.58778584982380044, 0.68094957983193261, 0.61446982018613894, 0.5395637932592392, 0.57367195265202853, 0.64503953194180885, 0.65957721152977322, 0.60870226800397587, 0.6573099304237825, 0.57768573235745913, 0.54324911900243955, 0.61865329357549481, 0.61819278033794156, 0.62212302340290959, 0.5978013463449896, 0.51034648052769493, 0.66355801030089456, 0.57396385651034609, 0.62035447727478099, 0.61218464805276951, 0.56999466883527605, 0.45305959157856684, 0.63070624378783768, 0.64069517484413108, 0.54854969729827419, 0.52446390168970813, 0.5831378422336676, 0.68664764615523632, 0.65045820909008767, 0.6036339116291678, 0.52647727478088013, 0.63639120809614169, 0.5848059998192825, 0.60110621668022046, 0.64445396223005336, 0.60672661968012997, 0.56482036685642001, 0.58527188940092167, 0.56409980121080694, 0.57663901689708141, 0.57177193458028375, 0.60721758380771662, 0.65730066865455861, 0.63668406072106254, 0.51611556880816845, 0.66789812053853803, 0.57492825517303703, 0.59693074003795066, 0.57095513689346711, 0.56492694497153706, 0.68377640733712841, 0.54327247673262857, 0.64418324749254541, 0.61591284901057208], 5: [0.63182673714647153, 0.5496009306948586, 0.58006275413391151, 0.65583003523990235, 0.65506794976054938, 0.65213440860215055, 0.61103912532755045, 0.68738294027288327, 0.65850424686003439, 0.68828377157314535, 0.52504468238908464, 0.6267395861570435, 0.68445373633324302, 0.58792310472576126, 0.6422207915424234, 0.71324577572964665, 0.5678286798590404, 0.59798260594560404, 0.63628584982380043, 0.64584616427216057, 0.53081449353935117, 0.56598847926267282, 0.55839278937381409, 0.58040277401283091, 0.53821875847113032, 0.62932447817836812, 0.63399353935122427, 0.57668144031806279, 0.66583563748079877, 0.64906799493991141, 0.60843724586608838, 0.43431101472847206, 0.64471668022047535, 0.61297370561127684, 0.6267395861570435, 0.61863861028282285, 0.57856916960332527, 0.64408181982470414, 0.61988971717719354, 0.6375661425860667, 0.53997185325743202, 0.62464927261227077, 0.64373570073190578, 0.65170389446101029, 0.690459700009036, 0.57418076262763162, 0.57558376253727306, 0.66969860847564833, 0.64388411493629705, 0.57786726303424596, 0.60080889129845483, 0.67633943254721229, 0.63777694948947317, 0.5974447908195536, 0.62924329086473296, 0.64598658172946599, 0.569083762537273, 0.64017904581187313, 0.58769341284901067, 0.60583636035059185, 0.55820660522273424, 0.47802453239360254, 0.69414633595373643, 0.56791831571338203, 0.68280685822716192, 0.61649281648143128, 0.5440474835095328, 0.45282583355923006, 0.64019363874582091, 0.64379041293936923, 0.55132285172133377, 0.55128462998102457, 0.5828849281648143, 0.67620122887864809, 0.64470886419083762, 0.5998765699828319, 0.59493787837715728, 0.62907359718080769, 0.54835651034607391, 0.61444519743381221, 0.61843417366946773, 0.5955847564832385, 0.56958227161832475, 0.65552249932230944, 0.64241334598355471, 0.58259139784946234, 0.55649936748893103, 0.56916662148730457, 0.65353736333242973, 0.62390065058281363, 0.49084309207553989, 0.67500515044727583, 0.58816074817023567, 0.62225313996566367, 0.63351734887503386, 0.55585601337309121, 0.69000528598536193, 0.61417141049968382, 0.64646896177825974, 0.61176086563657717], 6: [0.60869124423963139, 0.54117656094695943, 0.58453894461010214, 0.65377821451161111, 0.67019160567452796, 0.64884584801662604, 0.61232483961326467, 0.68400198789193101, 0.65745662781241532, 0.69584449263576387, 0.61016232944790816, 0.66249548206379327, 0.70422395409776806, 0.60648052769494887, 0.68595518207282913, 0.70432736965754039, 0.56911724044456491, 0.64569797596457945, 0.63533197795247132, 0.69264728472033976, 0.55871952652028556, 0.55774198066323299, 0.55840819553627896, 0.64157504292039391, 0.60917782596909742, 0.62245152254450153, 0.68334648052769498, 0.57573466160657816, 0.67068098852444202, 0.64498956356736237, 0.65170488840697571, 0.53911145748622025, 0.64571668022047535, 0.65477952471311096, 0.62393986626908826, 0.62011480075901337, 0.57770014457395868, 0.67923041474654366, 0.62216702810156332, 0.6163140869250926, 0.61188443119183156, 0.63994976054938113, 0.62218884973344168, 0.63220872865275146, 0.68655493810427415, 0.63388384386012464, 0.6192396765157675, 0.66532795698924718, 0.70035840787928083, 0.57786726303424596, 0.61285131471943621, 0.66900049697298258, 0.69319291587602783, 0.64196869070208729, 0.6147705791994218, 0.68893078521731277, 0.559963223999277, 0.64389333152615891, 0.56186102828228068, 0.6192396765157675, 0.56501612903225795, 0.47213639649408157, 0.67705760368663603, 0.5615659618686184, 0.66176014276678408, 0.5936474654377879, 0.5337387277491642, 0.48422919490376798, 0.62451852353844772, 0.68353198698834372, 0.5542752326737147, 0.55045970000903588, 0.56965975422427029, 0.70456496792265288, 0.62369544592030368, 0.61417141049968382, 0.61057332610463533, 0.63978228065419729, 0.5468803198698835, 0.60557011836992847, 0.62008010300894545, 0.56548969910544877, 0.56311602060178922, 0.66181020149995484, 0.63889608746724491, 0.63730356013373091, 0.58321559591578576, 0.64371460196982022, 0.65353736333242973, 0.63026479624107723, 0.58472738772928534, 0.71086983825788386, 0.56084797144664322, 0.67039003343272796, 0.63322381855968191, 0.54323529411764704, 0.68815266106442574, 0.60974410409325031, 0.63684964308303971, 0.60609831029185868], 7: [0.60669124423963139, 0.56588664498057295, 0.65431368031083392, 0.66388565103460739, 0.66671541519833732, 0.63993227613626102, 0.65669643986626913, 0.67089798500045172, 0.68863327911809891, 0.69290842143308917, 0.6235895003162556, 0.64859528327460014, 0.68784300171681578, 0.65721582181259608, 0.69325106171500861, 0.70225178458480175, 0.56812564380590946, 0.65041226167886523, 0.64296363061353567, 0.67654066142586067, 0.61232483961326467, 0.63516915153158038, 0.56135673624288418, 0.64198206379325928, 0.62209659347610013, 0.62188931056293484, 0.68186138971717725, 0.64073886328725027, 0.67263883617963316, 0.62645626637751872, 0.65513345983554705, 0.61654039034968833, 0.64118252462275227, 0.65061317430197874, 0.6193684376976597, 0.6292363784223366, 0.58393823981205384, 0.67779542784855884, 0.62407395861570436, 0.63075137797054315, 0.62962867082316798, 0.63804414023673994, 0.67164864010120162, 0.64117507002801122, 0.69970832203849287, 0.65047067859401819, 0.62328729556338658, 0.65923985723321588, 0.70085660070479805, 0.55582339387367852, 0.59430360531309312, 0.66009523809523807, 0.68378869612361071, 0.63716535646516681, 0.62852828228065427, 0.67811868618415105, 0.56000524080599978, 0.62199087376886231, 0.62260472576127224, 0.65934855877835008, 0.63109808439504833, 0.56537973253817653, 0.67010522273425499, 0.6195323032438782, 0.66281273154423048, 0.59550460829493079, 0.54591940001807182, 0.57594194451974334, 0.65028860576488656, 0.66823068582271616, 0.55025124243245682, 0.61721324658895804, 0.56965975422427029, 0.70533979398210889, 0.63264222463178821, 0.66010946959428929, 0.61433523086654007, 0.63835370922562573, 0.62260174392337575, 0.61751843317972344, 0.61836581729465989, 0.58712767687720258, 0.5517485316707329, 0.65800040661425863, 0.63451513508629254, 0.63150804192644805, 0.62356343182434271, 0.67917714827866627, 0.64403659528327462, 0.61193512243607118, 0.58421085208276868, 0.7051932773109244, 0.57206325110689438, 0.67840123791452067, 0.68535126954007408, 0.61163025210084032, 0.67164864010120162, 0.60974410409325031, 0.65438361796331446, 0.65309573506822083], 8: [0.62823958615704345, 0.6235029366585344, 0.67032691786391974, 0.65674604680581905, 0.64899182253546583, 0.65686224812505656, 0.656416869973796, 0.68216079334959789, 0.67974058010300897, 0.68578562392699016, 0.6235796963946868, 0.64442581548748534, 0.68317443751694218, 0.6927239540977681, 0.69279077437426584, 0.69957540435529064, 0.56807802475829039, 0.64019156049516579, 0.64977315442305961, 0.68651649046715468, 0.67223240263847484, 0.67097912713472474, 0.57475264299268092, 0.64398820818650049, 0.63613621577663326, 0.61822512876118196, 0.68148043733622488, 0.63716680220475286, 0.68100578295834457, 0.67597867534110423, 0.68341659889762352, 0.61401658082587873, 0.64295057377789822, 0.66005371826149806, 0.59884435709767769, 0.62666494985090815, 0.65617073280925275, 0.68324717628987075, 0.66986482334869435, 0.62077622661968013, 0.63731566820276497, 0.65285962772205663, 0.66345816391072554, 0.6866239721695131, 0.71919056654920033, 0.65042305954639912, 0.63746191379777717, 0.65819092798409684, 0.71190187042558961, 0.55491302972802026, 0.56426705520918052, 0.66262365591397843, 0.68685172133369488, 0.68993006234751975, 0.62344732086382948, 0.67875417909099123, 0.54707544953465237, 0.63792206560043374, 0.67451649046715456, 0.67062632149634049, 0.62726393783319789, 0.62443936929610544, 0.65686057648866003, 0.6539267642540888, 0.69154418541610185, 0.59550460829493079, 0.63401766513056834, 0.57366883527604595, 0.64891686997379594, 0.66940787928074452, 0.53738732267100386, 0.61159550917141048, 0.56281169241890305, 0.72447384114936297, 0.62924726664859487, 0.65662754133911638, 0.59703017981386097, 0.62700262040299992, 0.67240548477455508, 0.63570470768952736, 0.61836581729465989, 0.59631815306767877, 0.60936473298997018, 0.66714326375711575, 0.61425404355290503, 0.67602159573506815, 0.62166549200325294, 0.68732357459112681, 0.62628331977952478, 0.62017321767416655, 0.57811561398753064, 0.70100280112044822, 0.60027825969097315, 0.66027956989247316, 0.67779145206469682, 0.66200429203939637, 0.67601554170055123, 0.60683794162826432, 0.65607901870425589, 0.65861954459203031], 9: [0.67772047528688906, 0.66408986175115214, 0.68466603415559768, 0.63601996927803373, 0.67706176018794617, 0.65256794976054944, 0.6807951115930243, 0.70973782416192277, 0.66933387548567813, 0.68564276678413305, 0.65723664949850913, 0.63931349959338568, 0.68077003704707695, 0.69346588958163902, 0.69590702087286538, 0.69571826149814775, 0.56203370380410222, 0.63770890937019975, 0.69056288967199786, 0.67483907111231589, 0.70033369476822993, 0.67807016354929073, 0.62984562211981565, 0.62771622842685471, 0.64399335863377616, 0.66083694768229873, 0.7125599078341015, 0.64002394506189575, 0.67579090991235202, 0.66346421794524257, 0.67761434896539274, 0.63793778801843337, 0.67751798138610275, 0.67736717267552182, 0.60225083581819827, 0.62314692328544319, 0.65681218939188568, 0.70143683925182976, 0.66955959157856682, 0.65845030270172589, 0.63494086021505369, 0.69491845125146845, 0.6911625553447186, 0.68277143760730108, 0.71147628083491454, 0.65416888045540789, 0.63400953284539618, 0.67090937019969277, 0.70571401463811323, 0.56860748170235842, 0.62540805999819271, 0.65483739947591935, 0.68717665130568373, 0.71437688623836637, 0.67276050420168065, 0.70633509532845395, 0.61473506822083679, 0.64089324116743474, 0.67525535375440493, 0.714694948947321, 0.63927441944519736, 0.64095518207282909, 0.69364267642540889, 0.66743810427396766, 0.68611077979578927, 0.59564746543778802, 0.6337324929971988, 0.5993294027288335, 0.68280898165717896, 0.66716978404264926, 0.62032836360350596, 0.61144704978765696, 0.58694845034788112, 0.71881670732809255, 0.62881869522002354, 0.66038944610102113, 0.62818171139423506, 0.62326452516490471, 0.67771731273154434, 0.64408566007047996, 0.62127057919942175, 0.62821722237282007, 0.6588395229059365, 0.68162329447908188, 0.62447953374898346, 0.67776619680130112, 0.60939608746724494, 0.68695595012198429, 0.66249859943977585, 0.62624667931688804, 0.62653225806451618, 0.70355276949489476, 0.58264922743290859, 0.6876824342640282, 0.67741664407698554, 0.6857548116020602, 0.70479086473299002, 0.60150198789193099, 0.6912089997289238, 0.67949091894822444], 10: [0.68597393150808705, 0.66117814222463178, 0.68401364416734434, 0.63439766874491732, 0.67218356374807997, 0.64814154694135717, 0.67491646335953748, 0.70415573326104641, 0.66888908466612451, 0.68300185235384492, 0.67052543598084391, 0.6410619860847564, 0.67880365049245506, 0.68947009126231129, 0.71238619318695229, 0.69149471401463813, 0.62323678503659541, 0.63927613626095592, 0.68742003252914086, 0.67346426312460461, 0.68848766603415568, 0.70445342007770839, 0.66840449082858944, 0.68003569169603328, 0.63461240625282378, 0.65542798409686454, 0.71172743290864737, 0.65785904039034959, 0.67054273967651568, 0.67718311195445913, 0.71616196801301157, 0.67309663865546221, 0.67537512424324575, 0.67124392337580197, 0.64074898346435349, 0.65771283997469954, 0.69314683292671908, 0.69709632239992769, 0.66748441312008677, 0.65962221017439238, 0.63205701635492906, 0.68502489382849907, 0.68501129484051682, 0.6847238185596819, 0.70527907291949044, 0.64162966476913352, 0.68378598536188673, 0.66413824884792627, 0.70552353844763716, 0.59160138248847927, 0.63514389626818468, 0.67020190656907919, 0.68679569892473114, 0.71026484142043922, 0.67152647510617158, 0.70205566097406702, 0.59825119725309484, 0.63147813318875934, 0.67082958344628185, 0.71314348965392615, 0.66868550646064873, 0.63666946778711486, 0.70541289418993391, 0.66150533116472399, 0.6855226800397578, 0.65785904039034959, 0.66585348332881544, 0.58775372729737063, 0.6785558868708772, 0.69996394686907015, 0.66433708322038498, 0.64938144935393516, 0.64912632149634053, 0.71891194542333059, 0.64388316616969365, 0.65909618686184157, 0.62651734887503396, 0.66377338031986999, 0.66993765248034698, 0.64209008764796249, 0.6040983554712207, 0.67104084214330895, 0.66585348332881544, 0.67486138971717724, 0.67202159573506814, 0.66912347519653026, 0.62000515044727567, 0.68998192825517302, 0.6546947682298726, 0.66868049155145937, 0.65705638384386011, 0.71099326827505194, 0.64358204572151445, 0.6794037227794345, 0.67451188217222369, 0.69336554621848734, 0.70179226529321403, 0.6022870696665763, 0.70889825607662416, 0.67407635312189407], 11: [0.68592116201319242, 0.65859257251287606, 0.68007725670913532, 0.62267181711394226, 0.67326719074726671, 0.64785723321586697, 0.67026845576940453, 0.70428309388271437, 0.68410323484232405, 0.67371243336044095, 0.67982592391795438, 0.63271396945875125, 0.68069594289328639, 0.6886129484051684, 0.70658267823258325, 0.70935077256709134, 0.62505245323936032, 0.66628634679678322, 0.67982592391795438, 0.70428309388271437, 0.67628101563205922, 0.70543905304057097, 0.71012492093611634, 0.71001287611818931, 0.63139531941808991, 0.64892021324658899, 0.7116798138610283, 0.6380618505466702, 0.69756903406523896, 0.67179100027107619, 0.7142555344718533, 0.70001115930243063, 0.67013314358001264, 0.6620058281377067, 0.63331173759826509, 0.67136803108340115, 0.70415342911358092, 0.70381810788831667, 0.68264104996837438, 0.65502195716996481, 0.67818925634770033, 0.68603049606939548, 0.6822507906388362, 0.67825734164633589, 0.70584254992319517, 0.64556523899882534, 0.68162211981566823, 0.70684273064064329, 0.69678923827595551, 0.58698594921839697, 0.67522137887413025, 0.66867095870606308, 0.67878359085569717, 0.70415342911358092, 0.66274875756754315, 0.69809510255715201, 0.65397948856962129, 0.67441384295653739, 0.6711218939188579, 0.70680690340652386, 0.66863788741302976, 0.68498644619137983, 0.70510811421342734, 0.66393390259329543, 0.70529380139152431, 0.6380618505466702, 0.69602755941086114, 0.58218229872594196, 0.68071320140959612, 0.69602755941086114, 0.66409898798228961, 0.66454974247763632, 0.65346245595012209, 0.71376908828047347, 0.63702466793168877, 0.65344912803831212, 0.67421342730640643, 0.66298843408331076, 0.66979759645793802, 0.63189961145748619, 0.6551728562392698, 0.70381810788831667, 0.66274875756754315, 0.70529380139152431, 0.67576068491912888, 0.69392997198879558, 0.65896738050058734, 0.68525363693864649, 0.6523704255895908, 0.67489477726574498, 0.65378747628083489, 0.70597058823529413, 0.68521112315894095, 0.67621324658895821, 0.67713092979127132, 0.70052868889491271, 0.70094072467696766, 0.6156680220475288, 0.70993010752688179, 0.66454974247763632], 12: [0.7048955904942622, 0.70197009126231147, 0.6813399746995572, 0.63030482515586883, 0.67093105629348515, 0.69055557061534301, 0.66626845576940452, 0.70209261769223819, 0.68238519924098673, 0.68026321496340469, 0.67807508809975603, 0.62304730279208465, 0.70431038221740305, 0.683002665582362, 0.70431038221740305, 0.70171021957169966, 0.67379100027107619, 0.70713228517213333, 0.67807508809975603, 0.70423127315442324, 0.6845704798048251, 0.70345807355200152, 0.70658457576579026, 0.70736654016445277, 0.62304730279208465, 0.64937629890665949, 0.70658457576579026, 0.67928173850185236, 0.69243078521731272, 0.67239884340833123, 0.70911267732899608, 0.70574324568537095, 0.69942260775277865, 0.6594884340833107, 0.68151445739586158, 0.67854861299358449, 0.70209261769223819, 0.69942260775277865, 0.70695513689346712, 0.69654816119996388, 0.67379100027107619, 0.68151445739586158, 0.70075164904671539, 0.67875494714014639, 0.70143205023945066, 0.67716454323664954, 0.67716454323664954, 0.70736654016445277, 0.7046856871780971, 0.65394293846570883, 0.67568455769404534, 0.67807508809975603, 0.67716454323664954, 0.70545210987620854, 0.67807508809975603, 0.70606582633053239, 0.6806966657630793, 0.67093105629348515, 0.70345807355200152, 0.70694555886870891, 0.66163404716725394, 0.68696503117375984, 0.70246177825969092, 0.7032966476913346, 0.70075164904671539, 0.67928173850185236, 0.69654816119996388, 0.63295482063793251, 0.70345807355200152, 0.70387485316707332, 0.67928173850185236, 0.70823321586699195, 0.68965754043552907, 0.70911267732899608, 0.63030482515586883, 0.69570262943887229, 0.70246177825969092, 0.66178729556338667, 0.66889789464172755, 0.66036292581548739, 0.67023624288425043, 0.7048955904942622, 0.67807508809975603, 0.70384277582000543, 0.70384277582000543, 0.6929851811692419, 0.65822223728200968, 0.6832258064516129, 0.69311412306858222, 0.70158367217854889, 0.66178729556338667, 0.70387485316707332, 0.6813399746995572, 0.70097058823529412, 0.67379100027107619, 0.70078011204481794, 0.70972698111502663, 0.66410142766784142, 0.70502534562211994, 0.70823321586699195], 13: [0.69998188307581111, 0.69882723411945424, 0.6829958434986898, 0.67745509171410501, 0.69882723411945424, 0.69121943616156156, 0.65776140778892211, 0.69882723411945424, 0.67745509171410501, 0.67745509171410501, 0.69882723411945424, 0.67444325472124333, 0.69998188307581111, 0.67745509171410501, 0.70264624559501221, 0.69882723411945424, 0.70222368302159577, 0.70415555254359818, 0.69882723411945424, 0.7015141863196892, 0.67745509171410501, 0.69998188307581111, 0.70415555254359818, 0.70222368302159577, 0.65776140778892211, 0.65776140778892211, 0.70222368302159577, 0.70222368302159577, 0.69998188307581111, 0.67444325472124333, 0.70222368302159577, 0.70222368302159577, 0.69882723411945424, 0.65776140778892211, 0.70106582633053227, 0.67745509171410501, 0.69882723411945424, 0.69882723411945424, 0.70419463269178639, 0.69121943616156156, 0.70222368302159577, 0.70106582633053227, 0.69897009126231135, 0.67745509171410501, 0.69998188307581111, 0.7015141863196892, 0.7015141863196892, 0.70222368302159577, 0.70222368302159577, 0.67745509171410501, 0.70419463269178639, 0.69882723411945424, 0.67444325472124333, 0.7015141863196892, 0.67745509171410501, 0.70106582633053227, 0.70264624559501221, 0.69882723411945424, 0.70228987078702454, 0.7015141863196892, 0.70222368302159577, 0.6829958434986898, 0.70222368302159577, 0.70222368302159577, 0.69897009126231135, 0.70222368302159577, 0.69121943616156156, 0.65776140778892211, 0.70228987078702454, 0.69882723411945424, 0.70222368302159577, 0.70415555254359818, 0.70415555254359818, 0.70222368302159577, 0.65776140778892211, 0.69121943616156156, 0.69882723411945424, 0.65776140778892211, 0.69121943616156156, 0.70264624559501221, 0.67745509171410501, 0.69998188307581111, 0.67745509171410501, 0.70415555254359818, 0.69897009126231135, 0.70106582633053227, 0.65776140778892211, 0.69998188307581111, 0.69121943616156156, 0.69998188307581111, 0.7015141863196892, 0.70419463269178639, 0.6829958434986898, 0.70106582633053227, 0.67444325472124333, 0.69882723411945424, 0.70415555254359818, 0.69121943616156156, 0.70106582633053227, 0.70415555254359818]}}, {6: {1: [0.62143308936477815], 2: [0.6758505466702811], 3: [0.70863178819915063], 4: [0.72772359266287157], 5: [0.72734264028191919], 6: [0.72719978313906208], 7: [0.73121898436794086], 8: [0.72336184151079785], 9: [0.71807612722508363], 10: [0.71668654558597633], 11: [0.71212356555525436], 12: [0.70545210987620854], 13: [0.70264624559501221]}}]
        result = dict()
        for i in range(len(raw_data)):
            result.update(raw_data[i])
        # print(result)
        # raw_data = {condition:() }
        # raw_data = dict()
        # for condition in ERCondition.get_all():
        #     print("> Evaluating condition {}".format(condition))
        #     raw = self.evaluate(budget_range, condition)
        #     raw_data[condition] = raw
        #     # raw_data is dict: {CONDITION: {NOFEATURES: [AUCS]}}
        return result

    def evaluate_all(self, budget_range):
        """
        returns {condition: DF, } e.g. {2: Df}
        :param budget_range:
        :return:dict
        """
        raw_data, evaluated = self.evaluate_all_to_dict(budget_range)
        df_raw = pd.DataFrame(raw_data, index=budget_range)
        return df_raw, evaluated



class ERCostEvaluator(EREvaluator):

    def evaluate(self, budget_range, condition):
        """

        :param budget_range:
        :param condition:
        :return: df_budget_aucs (raw df with columns = cost, index all 'auc') and df_evaluated (df with CI usw.)
        """
        df_result_filtered = self._get_filtered_result(condition)
        list_budget_aucs = [self._get_aucs(row, budget_range) for i,row in df_result_filtered.iterrows()]
        df_budget_aucs = pd.concat(list_budget_aucs, axis='columns').transpose() # df with columns index= x times 'AUC' and columns=cost
        df_evaluated = self._get_df_evaluated(df_budget_aucs)
        return df_budget_aucs, df_evaluated



    def _get_aucs(self, row, budget_range):
        token = row.token
        df_features_ranked = self.parser.get_ordered_features(token)
        evaluator = AucForBudgetCalculator(df_features_ranked, self.df_cleaned_bin, self.target)
        df_aucs = evaluator.get_auc_for_budget_range(budget_range) # df with one col: AUC and index= cost
        return df_aucs



class ERNofeaturesEvaluator(EREvaluator):

    def evaluate(self, budget_range, condition):
        if condition in [ERCondition.LAYPERSON, ERCondition.DOMAIN, ERCondition.EXPERT]: # ranking conditions
            df_result_filtered = self._get_filtered_result(condition)
            list_nofeatures_aucs = [self._get_aucs(row, budget_range) for i,row in df_result_filtered.iterrows()] # list of dfs with index=nofeature and one column 'auc'
            result = {int(nofeature): list() for nofeature in list_nofeatures_aucs[0].index}
            for nofeature in result:
                result[nofeature] = [float(df.loc[nofeature]) for df in list_nofeatures_aucs]

        elif condition == ERCondition.CSFS: #csfs condition
            def bootstrap_row(row):
                p = list(row['p'])
                pf0 = list(row['p|f=0'])
                pf1 = list(row['p|f=1'])
                row['p'] = np.random.choice(p, replace=True, size=self.bootstrap_n)
                row['p|f=0'] = np.random.choice(pf0, replace=True, size=self.bootstrap_n)
                row['p|f=1'] = np.random.choice(pf1, replace=True, size=self.bootstrap_n)
                return row
            def aggregate(row):
                row['p'] = np.median(row['p'])
                row['p|f=0'] = np.median(row['p|f=0'])
                row['p|f=1'] = np.median(row['p|f=1'])
                return row
            def calc_ig(row, p_target):
                h_x = _H([p_target, 1-p_target])
                row['IG'] = IG_from_series(row, h_x=h_x, identifier='p')
                return row

            result = {nofeatures: list() for nofeatures in budget_range}
            p_target = self.df_answers_grouped['p'].loc[self.target][0]
            df_answers_tmp = self.df_answers_grouped.drop(self.target) # need to drop target
            for i in range(self.repetitions): # number of iterations for bootstrapping -> is number of aucs calculated
                # bootstrap answers
                df_answers_bootstrapped = df_answers_tmp.copy().apply(bootstrap_row, axis='columns')
                df_aggregated = df_answers_bootstrapped.apply(aggregate, axis='columns')
                df_aggregated = df_aggregated.apply(calc_ig, axis='columns', p_target=p_target)
                df_ordered = df_aggregated.sort_values('IG', ascending=False)
                # reset index
                df_ordered['Feature'] = df_ordered.index
                df_ordered = df_ordered.reset_index()

                evaluator = AUCForOrderedFeaturesCalculator(df_ordered, self.df_cleaned_bin, self.target)
                df_aucs = evaluator.get_auc_for_nofeatures_range(budget_range) # df with one col: AUC and index= cost
                for nofeature in df_aucs.index:
                    result[nofeature].append(df_aucs.loc[nofeature]['auc'])
            #     print(df_aucs['auc'])
            #     print(tabulate(df_ordered))
            # exit()

        elif condition == ERCondition.RANDOM: # random
            features = list(self.df_answers_grouped.drop(self.target).index)
            df_ordered = pd.DataFrame({'Feature': features})
            result = {nofeatures: list() for nofeatures in budget_range}
            for i in range(100):
                df_shuffled = df_ordered.sample(frac=1).reset_index(drop=True)
                evaluator = AUCForOrderedFeaturesCalculator(df_shuffled, self.df_cleaned_bin, self.target)
                df_aucs = evaluator.get_auc_for_nofeatures_range(budget_range) # df with one col: AUC and index= cost
                for nofeature in df_aucs.index:
                    result[nofeature].append(df_aucs.loc[nofeature]['auc'])

        elif condition == ERCondition.ACTUAL: # using IGs from actual values
            result = {nofeatures: -1 for nofeatures in budget_range}
            df = self.df_actual_metadata.drop(self.target)
            df_ordered = df.sort_values('IG', ascending=False)
            # reset index
            df_ordered['Feature'] = df_ordered.index
            df_ordered = df_ordered.reset_index()
            evaluator = AUCForOrderedFeaturesCalculator(df_ordered, self.df_cleaned_bin, self.target)
            df_aucs = evaluator.get_auc_for_nofeatures_range(budget_range) # df with one col: AUC and index= cost
            for nofeature in df_aucs.index:
                result[nofeature] = [df_aucs.loc[nofeature]['auc']] # list only used to keep same format as other conditions
        print('> condition {} done'.format(condition))
        return {condition: result}

    def _get_aucs(self, row, budget_range):
        token = row.token
        df_features_ranked = self.parser.get_ordered_features(token)
        evaluator = AUCForOrderedFeaturesCalculator(df_features_ranked, self.df_cleaned_bin, self.target)
        df_aucs = evaluator.get_auc_for_nofeatures_range(budget_range) # df with one col: AUC and index= cost
        return df_aucs

def test():
    token = '0:13,1:14,2:1,3:3,4:4,5:7,6:11,7:5,8:12,9:15,10:6,11:2,12:8,13:9,14:10|e7cf0fccca7858d47a96c82837e6d439'
    path = '../datasets/student/evaluation/student_base.csv'
    ERParser(path).parse(token)

    features = ERParser(path).get_ordered_features(token)
    print(features)

if __name__ == '__main__':
    test()